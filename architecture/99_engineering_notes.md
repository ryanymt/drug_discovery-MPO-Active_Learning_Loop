# 99. Engineering Log: Production System Verification (Phase 1)

**Status**: Active Learning Loop - Cycle 1 Complete / Cycle 2 In Progress
**Scale**: 100,000 Molecules
**Date**: January 2026

## 1. Executive Summary
This document records the engineering details, configuration, and observations from the "Phase 1" production scale-up. The objective was to validate the full end-to-end active learning loop, generating 100,000 molecules, scoring them with high-fidelity physics, and training the surrogate models for the next cycle.

A high-affinity binder (**-66.25 kcal/mol**) was successfully identified, and a Proxy Oracle was trained with **R²=0.82**.

---

## 2. Step I: Large Scale Generation (Pocket2Mol)
A distributed batch job was executed to generate 100,000 molecules using the `Pocket2Mol` generator. To optimize for Spot Instance reliability, a "Many Small Tasks" strategy was employed.

*   **Job ID**: `prod-pocket2mol-100k-v2`
*   **Scale**: 100 tasks × 1,000 molecules (50 GPUs concurrent)
*   **Output**: 70,506 Valid Molecules (70% Validity Rate)

### Key Assets
*   **Spec**: `workspace/prod-pocket2mol-100k-v2.json`
*   **Artifacts**: SMILES text files and 3D SDF structures stored in `gs://ryanymt/output/generated/shard_*/`.

To manage the massive file count, a **Manifest Consolidation** step (`consolidate_manifest.py`) was implemented, aggregating all 70k+ paths into a single CSV for downstream ingestion.

---

## 3. Step II: The Screening Funnel
The 100k candidates were passed through a multi-stage screening filter to remove toxic, insoluble, or non-drug-like compounds before expensive physics scoring.

### A. RDKit Filtering
QED (Quantitative Estimation of Drug-likeness), SA Score (Synthetic Accessibility), and LogP were calculated. This step ran efficiently on standard CPUs.

*   **Job**: `prod-rdkit-100k` (10 CPUs)
*   **Throughput**: 100k molecules processed in < 15 minutes.

### B. Toxicity Screening (TxGemma)
The `google/txgemma-9b-predict` model was utilized to flag potential clinical toxicity.

*   **Job**: `prod-txgemma-100k` (100 x L4 GPUs)
*   **Outcome**: Flagged molecules with `toxicity_label=1` were excluded from the Oracle candidates.

### C. Molecular Docking (Gnina) - *Challenges Encountered*
The CNN-based docking engine `gnina` was deployed to estimate binding affinity.

> [!CAUTION]
> **Issue: Coordinate Reset (Jan 2026)**
> The production run `prod-gnina-100k` resulted in `NaN` scores.
> **Root Cause**: The execution script utilized `obabel --gen3d`, which reset the carefully generated coordinates from Pocket2Mol to `(0,0,0)`. Gnina's `autobox_ligand` feature subsequently centered the search grid on empty space, missing the protein pocket entirely.
> **Resolution**: Future runs will bypass `obabel` and directly injection the valid SDFs generated by Pocket2Mol.

> [!TIP]
> **Performance Optimization**
> Gnina was found to be CPU-bound (Vina search). A standard GPU node leaves the GPU 95% idle.
> **Fix**: Use `n1-highcpu-16` (16 vCPUs) to run 16 concurrent workers per T4 GPU. This saturates the hardware and increases throughput from 4 to **30 molecules/minute**.

---

## 4. Step III: The Oracle (MM-GBSA)
For the "Ground Truth" confirmation, top candidates were selected to undergo Molecular Mechanics with Generalized Born Surface Area (MM-GBSA) calculations using GROMACS.

### Selection Strategy
**876 Candidates** were selected for this expensive step:
1.  **Exploitation (Top 800)**: Best docking scores (due to the NaN issue, this was effectively random, serving as a baseline).
2.  **Exploration (Random)**: Diversity sampling.
3.  **Safety**: Must be Non-Toxic (`TxGemma=0`) and Drug-Like (`QED>0.4`).

### Execution Details
*   **Job**: `prod-mmpbsa-100k`
*   **Compute**: 100 x `g2-standard-12` (L4 GPU).
*   **Throughput**: ~1 hour per molecule (1.0 ns Simulation).

### Results
*   **Success Rate**: 92% (810/876 completed).
*   **Top Hit**: **-66.25 kcal/mol** (Significant affinity).
*   **Population Mean**: -35.5 kcal/mol.

---

## 5. Step IV: Closing the Loop (Learning)
With the Ground Truth data established, the surrogate models were trained to guide the next generation cycle.

### Surrogate Model Training (XGBoost)
A "Proxy Oracle" was trained to predict MM-GBSA DeltaG scores based solely on molecular fingerprints (ECFP4), bypassing the need for docking poses.

*   **Training Set**: 810 labeled molecules.
*   **Validation**:
    *   **R² Score**: **0.82** (Excellent predictivity).
    *   **RMSE**: 5.20 kcal/mol.
*   **Inference**: The model scored the remaining 70,000 molecules in seconds (`prod-inference-100k`).

### Elite Selection (Cycle 2 Prep)
To prevent "Mode Collapse" (generating similar molecules repeatedly), a clustering-based selection strategy was implemented for the next training set.

*   **Strategy**:
    1.  Filter for valid properties (`SA < 4.0`).
    2.  Cluster the top 20k candidates (Morgan Fingerprints).
    3.  Select Centroids (Tier 1) + Random Diversity (Tier 2).
*   **Outcome**: Created a dataset of **10,000 Elite Candidates** (`cycle-02-baseline`).

---

## 6. Step V: Cycle 2 Initiation
The loop continues with the retraining of the generator.

1.  **Fine-Tuning**: Job `cycle-02-pocket2mol-finetune-a100-v5` successfully retrained Pocket2Mol on the Elite Dataset.
2.  **New Generation**: Job `prod-pocket2mol-cycle2-10k` is currently running to generate 10,000 new molecules from the biased distribution.

## 7. Operational Runbook

### Standard Procedures
| Action | Command / Script |
| :--- | :--- |
| **Ingest New Batch** | `python3 workspace/upsert_registry.py --csv <batch.csv>` |
| **Prep Oracle** | `python3 workspace/prep_oracle_batches.py` |
| **Consolidate Scores** | `python3 workspace/consolidate_scores.py` |
| **Train Proxy** | `python3 workspace/train_xgboost.py` |

### BigQuery Schema
*   **`bioops_platform.molecule_registry`**: Source of Truth (SMILES, Hash).
*   **`bioops_platform.screening_results`**: Fast scores (Tox, QED).
*   **`bioops_platform.final_affinity`**: Ground Truth (DeltaG).
*   **`bioops_platform.v_leaderboard`**: Unified view for checking top candidates.
